# Развёртывание и эксплуатация TPMS на Strapi

## 1. Требования
- Node.js:
  - рекомендовано LTS или версия, совместимая со Strapi 5 (в проекте использовалась 22.x);
- NPM:
  - установлен вместе с Node.js;
- База данных:
  - по умолчанию SQLite (файл .tmp/data.db);
  - при необходимости можно переключиться на PostgreSQL/MySQL, изменив config/database.ts.

## 2. Переменные окружения
- Файл .env (создайте на основе .env.example):
  - STRAPI_ENCRYPTION_KEY:
    - строка длиной не менее 32 символов;
    - используется для шифрования токенов Telegram‑ботов;
    - без него сервис публикации работать не будет.
  - STRAPI_ADMIN_BACKEND_URL:
    - базовый URL приложения;
    - примеры:
      - локально: http://localhost:1337;
      - в продакшене: https://tpms.example.com.
- Дополнительные переменные:
  - стандартные переменные Strapi (APP_KEYS, API_TOKEN_SALT, ADMIN_JWT_SECRET и др.)
    генерируются при создании проекта; важно сохранить их при деплое.

## 3. Локальная разработка
- Установка зависимостей:
  - в корне tpms-strapi:
    - npm install
- Запуск в dev‑режиме (горячая перезагрузка):
  - npm run develop
  - Админка: http://localhost:1337/admin
- Остановка:
  - в терминале с dev‑сервером: Ctrl + C

## 4. Сборка и запуск в продакшене
- Сборка админки:
  - npm run build
- Запуск без авто‑перезагрузки:
  - npm run start
- Особенности:
  - перед первым стартом убедитесь, что:
    - .env настроен корректно (все ключи и URL);
    - база данных доступна и проконфигурирована;
    - порт 1337 открыт или перенаправлен через reverse‑proxy.

## 5. Reverse‑proxy (Nginx / Caddy и др.)
- Типовой сценарий:
  - Strapi работает на 127.0.0.1:1337;
  - внешние запросы приходят на 80/443 порт фронтового сервера;
  - reverse‑proxy пробрасывает HTTP‑трафик к Strapi.
- Важно:
  - корректно настроить заголовки X-Forwarded-*;
  - убедиться, что STRAPI_ADMIN_BACKEND_URL совпадает с публичным URL,
    чтобы ссылки на медиа и API формировались правильно.

## 6. Бекапы и миграции
- SQLite:
  - достаточно копировать файл .tmp/data.db;
  - перед копированием обязательно остановить Strapi, чтобы избежать порчи файла.
- Другие СУБД:
  - использовать штатные средства (pg_dump, mysqldump и т.п.).
- Контент‑типы и схемы:
  - описаны в файлах JSON/TS в src/api и src/components;
  - их изменения должны попадать под версионный контроль (git).

## 7. Логи и мониторинг
- Логи Strapi:
  - по умолчанию выводятся в stdout;
  - в проде рекомендуется:
    - собирать логи через systemd/journalctl;
    - либо перенаправлять в внешний лог‑агрегатор.
- Ошибки публикации в Telegram:
  - фиксируются в полях error_message поста;
  - дополнительно записываются в Audit Log (контент‑тип audit-log).

## 8. Обновление и миграции версий
- Перед обновлением:
  - сделать бекап базы;
  - закоммитить/сохранить все изменения кода;
  - проверить changelog Strapi на breaking‑изменения.
- Обновление:
  - изменить версии пакетов Strapi в package.json;
  - выполнить npm install;
  - запустить npm run build, затем npm run start;
  - проверить админку и критические функции (создание поста, публикация, cron).

## 9. Настройка прав доступа
- Через админку:
  - Settings → Users & Permissions Plugin → Roles;
  - для каждой роли определить:
    - доступ к Channels, Posts, Post History, Audit Log;
    - доступ к custom routes publish-now, cancel, retry.
- Рекомендации:
  - ролям публичного доступа (Public) не давать прав на управление каналами и постами;
  - использовать Authenticated или кастомные роли для операторов контента.

## 10. Среда разработки vs продакшн
- Разработка:
  - режим develop, горячая перезагрузка;
  - можно изменять схему контент‑типов и компоненты;
  - можно использовать SQLite для скорости и простоты.
- Продакшн:
  - режим build + start;
  - стабильная СУБД (PostgreSQL и т.п.);
  - строгий контроль над изменениями схем (миграции, тестирование).

Этот файл даёт базовое представление о развёртывании и эксплуатации TPMS.
Дополнительные детали по сущностям и логике см. в RU_PROJECT_OVERVIEW.md
и RU_ARCHITECTURE.md в директории docs/.

