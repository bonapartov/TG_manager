# Обзор проекта TPMS (Telegram Post Management System) на Strapi

## Назначение проекта
- Проект решает задачу планирования и публикации постов в Telegram‑каналы.
- Админка полностью построена на Strapi и заменяет старый стек (FastAPI + Vue).
- Основные возможности:
  - управление Telegram‑каналами;
  - создание, редактирование и планирование постов;
  - поддержка медиа (фото, видео, файлы) и inline‑кнопок;
  - автоматическая публикация по расписанию через cron;
  - аудит действий (история изменений и лог публикаций).

## Технологии и стек
- Ядро:
  - Strapi 5 (Node.js, TypeScript) в режиме self‑hosted;
  - база данных по умолчанию: SQLite (файл .tmp/data.db).
- Язык админки:
  - интерфейс переведен на русский (см. src/admin/app.js).
- Интеграция с Telegram:
  - прямые HTTP‑запросы к Bot API;
  - шифрование токенов ботов (AES‑256‑GCM);
  - поддержка sendMessage, sendPhoto, sendVideo, sendDocument, sendMediaGroup.
- Безопасность:
  - токен бота хранится только в зашифрованном виде;
  - детализированный Audit Log;
  - разделение прав доступа через Strapi Roles & Permissions.

## Основные директории проекта
- Корень tpms-strapi:
  - package.json — зависимости и npm‑скрипты;
  - tsconfig.json — настройки TypeScript;
  - .env.example — пример переменных окружения;
  - README.md — базовые команды Strapi.
- config/:
  - database.ts — подключение к БД;
  - server.ts — порт, host, proxy и др.;
  - admin.ts — конфигурация админки;
  - cron-tasks.ts — задачи по расписанию (публикация постов);
  - plugins.ts — подключение и конфигурация плагинов;
  - middlewares.ts — цепочка middleware.
- src/api/:
  - channels/ — тип контента Telegram‑канала:
    - content-types/channel/schema.json — схема;
    - content-types/channel/lifecycles.ts — шифрование токена бота.
  - posts/ — посты для публикации:
    - content-types/post/schema.json — схема поста;
    - services/publisher.ts — сервис публикации в Telegram;
    - controllers/publisher.ts — контроллер для ручного вызова;
    - routes/publisher.ts — кастомные роуты (publish-now, cancel, retry).
  - post-history/ — история изменений постов (diff и автор);
  - audit-log/ — общий аудит действий (publish, cancel, retry и др.).
- src/components/shared/:
  - telegram-media.json — компонент медиа объекта;
  - telegram-button.json — компонент кнопки;
  - button-row.json — строка кнопок.
- src/admin/:
  - app.js — конфигурация админки (локали и bootstrap);
  - tsconfig.json — TS настройки для админки.
- public/:
  - uploads/ — директория для загружаемых медиа (файлы админки).
- docs/:
  - RU_guide_channel_post.md — практическое руководство по каналам и постам;
  - RU_PROJECT_OVERVIEW.md — текущий файл (обзор);
  - дальнейшие файлы документации (архитектура, деплой).

## Основные сущности домена
- Channel (канал):
  - хранит данные Telegram‑канала и токен бота;
  - токен зашифрован, используется только на стороне сервера при отправке.
- Post (пост):
  - привязан к Channel;
  - содержит текст, медиа, кнопки, статус, расписание;
  - поддерживает черновики, отложенную публикацию, ошибочные состояния.
- Post History:
  - фиксирует изменения полей поста, автора изменения и время.
- Audit Log:
  - общий лог бизнес‑действий (publish, cancel, retry, системные события).

## Потоки работы
- Оператор:
  - через админку создаёт канал с токеном бота;
  - создает пост, добавляет медиа и кнопки, настраивает расписание;
  - при необходимости запускает мгновенную публикацию или отменяет/повторяет.
- Система:
  - cron‑задача публикует посты в нужное время;
  - сохраняет результаты публикации и возможные ошибки;
  - ведёт журнал действий в Audit Log и Post History.

Дополнительные детали см. в файлах архитектуры и деплоя в директории docs/.

